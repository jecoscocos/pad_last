# Архитектурная диаграмма

## Общая схема микросервисов

```
┌──────────────────────────────────────────────────────────────┐
│                         КЛИЕНТ                                │
│                    (Веб-браузер)                              │
└───────────────────────┬──────────────────────────────────────┘
                        │
                        │ HTTP
                        ▼
┌──────────────────────────────────────────────────────────────┐
│                    API GATEWAY                                │
│                    (Port 5000)                                │
│  - Маршрутизация запросов                                     │
│  - Управление сессиями                                        │
│  - Рендеринг UI (Jinja2)                                      │
│  - Агрегация данных                                           │
└───┬────────┬────────┬────────┬─────────────────────────────┘
    │        │        │        │
    │ HTTP   │ HTTP   │ HTTP   │ HTTP
    │        │        │        │
    ▼        ▼        ▼        ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│  AUTH  │ │PROPERTY│ │INQUIRY │ │PROJECT │
│SERVICE │ │SERVICE │ │SERVICE │ │SERVICE │
│ :5001  │ │ :5002  │ │ :5003  │ │ :5004  │
└────┬───┘ └───┬────┘ └───┬────┘ └───┬────┘
     │         │           │          │
     ▼         ▼           ▼          ▼
  ┌─────┐  ┌─────┐     ┌─────┐   ┌─────┐
  │auth │  │prop │     │inq  │   │proj │
  │ .db │  │ .db │     │ .db │   │ .db │
  └─────┘  └──┬──┘     └─────┘   └─────┘
             │
             ▼
         ┌────────┐
         │uploads/│
         │(файлы) │
         └────────┘
```

## Межсервисное взаимодействие

```
┌──────────────┐
│ API Gateway  │
└──────┬───────┘
       │
       │ Все запросы проходят через Gateway
       │
       ▼
┌──────────────┐       ┌──────────────┐
│ Auth Service │◄──────┤ All Services │
└──────┬───────┘       └──────────────┘
       │
       │ JWT токены для аутентификации
       │
       ▼
Все сервисы проверяют токены через Auth Service

┌────────────────┐
│ Inquiry Service│
└───────┬────────┘
        │
        │ Проверяет существование объектов
        ▼
┌────────────────┐
│Property Service│
└────────────────┘
```

## Data Flow - Создание объекта недвижимости

```
1. Браузер                 POST /properties/new
   │
   ▼
2. API Gateway            Проверка сессии
   │                      Подготовка данных
   ▼
3. Property Service       Проверка JWT токена
   │                      
   │────────────────────► Auth Service (verify token)
   │◄────────────────────
   │
   │                      Сохранение в БД
   ▼                      Загрузка фото
4. property.db + uploads/
   │
   ▼
5. API Gateway           Рендеринг HTML
   │
   ▼
6. Браузер               Отображение
```

## Data Flow - Создание заявки

```
1. Браузер               POST /properties/{id}/inquiry
   │
   ▼
2. API Gateway          Подготовка данных
   │
   ▼
3. Inquiry Service      Проверка property_id
   │
   │────────────────────► Property Service (GET /properties/{id})
   │◄────────────────────
   │
   │                     Поиск/создание клиента
   │                     Создание заявки
   ▼
4. inquiry.db
   │
   ▼
5. API Gateway          Редирект
   │
   ▼
6. Браузер             Уведомление
```

## Безопасность

```
┌──────────────┐
│   Браузер    │
└──────┬───────┘
       │
       │ 1. POST /login
       ▼
┌──────────────┐
│ API Gateway  │
└──────┬───────┘
       │
       │ 2. Передача credentials
       ▼
┌──────────────┐
│ Auth Service │
└──────┬───────┘
       │
       │ 3. Проверка пароля
       │ 4. Генерация JWT токена
       │
       ▼
    JWT Token (включает: user_id, email, role, exp)
       │
       │ 5. Возврат токена
       ▼
┌──────────────┐
│ API Gateway  │ Сохранение в session
└──────┬───────┘
       │
       │ 6. Дальнейшие запросы с токеном
       ▼
   Headers: Authorization: Bearer <JWT>
       │
       ▼
┌──────────────┐
│   Services   │ Проверка через Auth.verify()
└──────────────┘
```

## Масштабирование

```
Текущая архитектура:

┌───────────┐
│  Gateway  │ x1
└─────┬─────┘
      │
  ┌───┴───┐
  ▼       ▼
┌────┐  ┌────┐
│Auth│  │Prop│ x1 каждый
└────┘  └────┘

Масштабированная архитектура:

         ┌─────────────┐
         │Load Balancer│
         └──────┬──────┘
                │
      ┌─────────┼─────────┐
      ▼         ▼         ▼
  ┌────────┬────────┬────────┐
  │Gateway │Gateway │Gateway │ x3
  └────┬───┴───┬────┴───┬────┘
       │       │        │
   ┌───┴───────┴────────┴───┐
   ▼                        ▼
┌─────┐                  ┌─────┐
│Auth │ x1               │Prop │ x5 (высокая нагрузка)
└─────┘                  └─────┘
```

## Отказоустойчивость

```
Healthcheck каждые 30 секунд:

┌──────────────┐
│Docker Compose│
└──────┬───────┘
       │
       │ Проверка /health endpoint
       ▼
┌──────────────┐
│   Service    │────► Healthy (200 OK)
└──────────────┘
       │
       │ Нет ответа → Unhealthy
       ▼
   Перезапуск контейнера

Circuit Breaker паттерн (будущее улучшение):

Request → Service A ──X──► Service B (недоступен)
              │
              │ После N неудач
              ▼
        Открыть Circuit
              │
              ▼
        Возврат fallback ответа
```

## Volumes и данные

```
Docker Volumes:

auth-data/
├── auth.db
└── (SQLite база данных)

property-data/
├── property.db
└── (SQLite база данных)

property-uploads/
├── uuid1_photo1.jpg
├── uuid2_photo2.jpg
└── (фотографии объектов)

inquiry-data/
├── inquiry.db
└── (SQLite база данных)

project-data/
├── project.db
└── (SQLite база данных)
```
