{% extends "base.html" %}
{% block title %}–û—Ç—á—ë—Ç—ã - –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏{% endblock %}
{% block content %}
<div class="card">
	<h2 style="margin-bottom: 2rem;">üìÑ –û—Ç—á—ë—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

	<div style="display: grid; gap: 2rem;">
		<div class="report-section">
			<div class="report-header">
				<div>
					<h3>üè† –û—Ç—á—ë—Ç –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h3>
					<p class="text-muted">–ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º –≤ —Å–∏—Å—Ç–µ–º–µ</p>
				</div>
				<button onclick="generateReport('properties')" class="btn-primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
			</div>
			<div id="report-properties" class="report-result"></div>
		</div>
		
		<div class="report-section">
			<div class="report-header">
				<div>
					<h3>üì® –û—Ç—á—ë—Ç –ø–æ –∑–∞—è–≤–∫–∞–º</h3>
					<p class="text-muted">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</p>
				</div>
				<button onclick="generateReport('inquiries')" class="btn-primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
			</div>
			<div id="report-inquiries" class="report-result"></div>
		</div>
	</div>
</div>

<script>
async function generateReport(type) {
	const container = document.getElementById(`report-${type}`);
	container.innerHTML = '<div class="loading">‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞...</div>';
	
	try {
		const response = await fetch(`/reports/${type}`);
		const data = await response.json();
		
		if (response.ok) {
			if (type === 'properties') {
				container.innerHTML = formatPropertiesReport(data);
			} else if (type === 'inquiries') {
				container.innerHTML = formatInquiriesReport(data);
			}
		} else {
			container.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç'}</div>`;
		}
	} catch (error) {
		container.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
	}
}

function formatPropertiesReport(data) {
	let html = '<div class="report-content">';
	
	// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
	html += '<div class="stats-grid">';
	html += `<div class="stat-card">
		<div class="stat-value">${data.total || 0}</div>
		<div class="stat-label">–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤</div>
	</div>`;
	
	if (data.by_type) {
		for (let [type, count] of Object.entries(data.by_type)) {
			const typeNames = {
				'apartment': 'üè¢ –ö–≤–∞—Ä—Ç–∏—Ä—ã',
				'house': 'üè† –î–æ–º–∞',
				'commercial': 'üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è',
				'land': 'üå≥ –ó–µ–º–ª—è'
			};
			html += `<div class="stat-card">
				<div class="stat-value">${count}</div>
				<div class="stat-label">${typeNames[type] || type}</div>
			</div>`;
		}
	}
	html += '</div>';
	
	// –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
	if (data.properties && data.properties.length > 0) {
		html += '<div style="margin-top: 2rem;"><h4>–°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤:</h4>';
		html += '<div style="overflow-x: auto;"><table class="report-table">';
		html += '<thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–ì–æ—Ä–æ–¥</th><th>–¶–µ–Ω–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
		
		data.properties.forEach(prop => {
			html += `<tr>
				<td>#${prop.id}</td>
				<td><strong>${prop.title || 'N/A'}</strong></td>
				<td>${prop.property_type || 'N/A'}</td>
				<td>${prop.city || 'N/A'}</td>
				<td style="color: #10b981; font-weight: 600;">‚Ç¨${prop.price ? prop.price.toLocaleString() : '0'}</td>
				<td><span class="badge">${prop.status || 'N/A'}</span></td>
			</tr>`;
		});
		
		html += '</tbody></table></div></div>';
	}
	
	html += '</div>';
	return html;
}

function formatInquiriesReport(data) {
	let html = '<div class="report-content">';
	
	// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
	html += '<div class="stats-grid">';
	html += `<div class="stat-card">
		<div class="stat-value">${data.total || 0}</div>
		<div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
	</div>`;
	
	if (data.by_status) {
		const statusNames = {
			'new': 'üÜï –ù–æ–≤—ã–µ',
			'in_progress': '‚è≥ –í —Ä–∞–±–æ—Ç–µ',
			'done': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω—ã',
			'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω—ã'
		};
		for (let [status, count] of Object.entries(data.by_status)) {
			html += `<div class="stat-card">
				<div class="stat-value">${count}</div>
				<div class="stat-label">${statusNames[status] || status}</div>
			</div>`;
		}
	}
	html += '</div>';
	
	// –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫
	if (data.inquiries && data.inquiries.length > 0) {
		html += '<div style="margin-top: 2rem;"><h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏:</h4>';
		html += '<div style="overflow-x: auto;"><table class="report-table">';
		html += '<thead><tr><th>ID</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>';
		
		data.inquiries.slice(0, 20).forEach(inq => {
			const statusColors = {
				'new': '#3b82f6',
				'in_progress': '#f59e0b',
				'done': '#10b981',
				'rejected': '#ef4444'
			};
			html += `<tr>
				<td>#${inq.id}</td>
				<td><strong>${inq.name || 'N/A'}</strong></td>
				<td>${inq.email || 'N/A'}</td>
				<td>${inq.phone || 'N/A'}</td>
				<td><span class="badge" style="background: ${statusColors[inq.status] || '#6b7280'};">${inq.status || 'N/A'}</span></td>
				<td>${inq.created_at ? new Date(inq.created_at).toLocaleDateString('ru-RU') : 'N/A'}</td>
			</tr>`;
		});
		
		html += '</tbody></table></div></div>';
	}
	
	html += '</div>';
	return html;
}
</script>

<style>
.report-section {
	background: rgba(255, 255, 255, 0.6);
	padding: 2rem;
	border-radius: 16px;
	border: 1px solid var(--border);
}

.report-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 1.5rem;
	flex-wrap: wrap;
	gap: 1rem;
}

.report-header h3 {
	margin: 0;
	color: var(--text);
}

.report-result {
	min-height: 50px;
}

.loading {
	text-align: center;
	padding: 2rem;
	color: var(--primary);
	font-size: 1.1rem;
	font-weight: 500;
}

.error {
	padding: 1rem;
	background: rgba(239, 68, 68, 0.1);
	border-left: 4px solid #ef4444;
	border-radius: 8px;
	color: #991b1b;
	font-weight: 500;
}

.report-content {
	animation: fadeIn 0.4s ease;
}

.stats-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
	gap: 1rem;
	margin-top: 1rem;
}

.stat-card {
	background: white;
	padding: 1.5rem;
	border-radius: 12px;
	text-align: center;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
	transition: transform 0.3s ease;
}

.stat-card:hover {
	transform: translateY(-5px);
	box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.stat-value {
	font-size: 2.5rem;
	font-weight: 800;
	background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
	background-clip: text;
}

.stat-label {
	font-size: 0.9rem;
	color: var(--text-muted);
	margin-top: 0.5rem;
	font-weight: 500;
}

.report-table {
	width: 100%;
	border-collapse: collapse;
	background: white;
	border-radius: 12px;
	overflow: hidden;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
	margin-top: 1rem;
}

.report-table thead {
	background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
	color: white;
}

.report-table th {
	padding: 1rem;
	text-align: left;
	font-weight: 600;
	font-size: 0.9rem;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}

.report-table td {
	padding: 1rem;
	border-bottom: 1px solid var(--border);
	color: var(--text);
}

.report-table tbody tr:hover {
	background: var(--secondary);
}

.report-table tbody tr:last-child td {
	border-bottom: none;
}

.badge {
	display: inline-block;
	padding: 0.35rem 0.75rem;
	background: var(--primary);
	color: white;
	border-radius: 20px;
	font-size: 0.85rem;
	font-weight: 600;
	text-transform: capitalize;
}

@keyframes fadeIn {
	from {
		opacity: 0;
		transform: translateY(10px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}
</style>
{% endblock %}
